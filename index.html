<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Timecard</title>
<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  padding:15px;
}

/* TABLE */
table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
}

th,td{
  padding:12px 8px;
  text-align:center;
  border:1px solid #ddd;
}

th{
  background:#f7f7f7;
  font-weight:600;
}

/* COLUMN WIDTHS */
th:nth-child(1),td:nth-child(1){width:30%;}
th:nth-child(2),td:nth-child(2){width:20%;}
th:nth-child(3),td:nth-child(3){width:20%;}
th:nth-child(4),td:nth-child(4){width:15%;}
th:nth-child(5),td:nth-child(5){width:15%;}

/* INPUTS */
input{
  width:100%;
  height:42px;
  padding:6px 10px;
  font-size:15px;
  border:1px solid #d0d0d0;
  border-radius:10px;
  background:#fff;
  box-sizing:border-box;
  text-align:center;
}

/* TODAY ROW */
.today-row{
  background:#e6f9ec;
  border-left:5px solid #28a745;
}

/* BUTTONS */
button{
  padding:6px 12px;
  font-size:14px;
  border-radius:8px;
  border:none;
  background:#007aff;
  color:white;
}

button:disabled{
  background:#ccc!important;
  color:#666;
  cursor:not-allowed;
}

/* SMALL ARROWS */
.arrow-btn{
  width:32px;
  height:32px;
  padding:0;
  font-size:14px;
  border-radius:8px;
}

/* NAV LAYOUTS */
.nav-row{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  margin:12px 0;
}

#weekLabel{
  font-weight:600;
  font-size:18px;
  min-width:80px;
  text-align:center;
}

h2{margin-bottom:20px;}
</style>
</head>
<body>

<h2>Timecard</h2>

<label><strong>Name:</strong></label>
<select id="userSelect" onchange="loadUser()"></select>
<button onclick="createName()">+ Add</button>
<button onclick="deleteName()" style="background:#dc3545;">Delete</button>

<br><br>

<label><strong>Pay Rate:</strong></label>
<select id="payRate" onchange="autoSave();calculate();">
<option value="7.60">£7.60</option>
<option value="10.05">£10.05</option>
<option value="12.25" selected>£12.25</option>
<option value="12.82">£12.82</option>
</select>

<br><br>

<div class="nav-row">
<button id="prevSlip" class="arrow-btn" onclick="changePayslip(-1)">◀</button>
<span id="cycleRange" style="font-weight:600;"></span>
<button id="nextSlip" class="arrow-btn" onclick="changePayslip(1)">▶</button>
</div>

<label><strong>View:</strong></label>
<select id="viewSelect" onchange="setView(this.value)">
<option value="week">Week View</option>
<option value="month">Month View</option>
</select>
<button onclick="goToToday()">Today</button>

<div id="weekControls" class="nav-row">
<button id="prevWeek" class="arrow-btn" onclick="changeWeek(-1)">◀</button>
<span id="weekLabel"></span>
<button id="nextWeek" class="arrow-btn" onclick="changeWeek(1)">▶</button>
</div>

<table>
<thead>
<tr>
<th>Date</th>
<th>Clock In</th>
<th>Clock Out</th>
<th>Break</th>
<th>Total</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<h3>Total Hours: <span id="weekTotal">0.00</span></h3>
<h3>Total Money: £<span id="totalMoney">0.00</span></h3>

<script>

/* ================= PAYSLIPS ================= */

const payslips=[];
let start=new Date(2025,11,8);

while(start<=new Date(2026,11,7)){
  payslips.push(new Date(start));
  start.setDate(start.getDate()+28);
}

let currentPayslipIndex=2;
let cycleStartDate;
let currentView="week";
let currentWeek=1;
let currentUser="default";

/* ================= USER ================= */

function loadUserList(){
  let users=JSON.parse(localStorage.getItem("users"))||["default"];
  const sel=document.getElementById("userSelect");
  sel.innerHTML="";
  users.forEach(u=>{
    let o=document.createElement("option");
    o.value=u;o.textContent=u;
    sel.appendChild(o);
  });
}

function createName(){
  const name=prompt("Enter name:");
  if(!name)return;
  let users=JSON.parse(localStorage.getItem("users"))||["default"];
  if(users.includes(name))return;
  users.push(name);
  localStorage.setItem("users",JSON.stringify(users));
  loadUserList();
  document.getElementById("userSelect").value=name;
  currentUser=name;
  renderDates();
}

function deleteName(){
  if(currentUser==="default")return;
  let users=JSON.parse(localStorage.getItem("users"))||[];
  users=users.filter(u=>u!==currentUser);
  localStorage.setItem("users",JSON.stringify(users));
  currentUser="default";
  loadUserList();
  renderDates();
}

/* ================= PAYSLIP NAV ================= */

function updatePayslip(){
  cycleStartDate=new Date(payslips[currentPayslipIndex]);
  const end=new Date(cycleStartDate);
  end.setDate(end.getDate()+27);

  const options={day:"numeric",month:"short",year:"numeric"};
  document.getElementById("cycleRange").innerText=
  `Payslip ${currentPayslipIndex+9}: ${cycleStartDate.toLocaleDateString("en-GB",options)} - ${end.toLocaleDateString("en-GB",options)}`;

  document.getElementById("prevSlip").disabled=currentPayslipIndex===0;
  document.getElementById("nextSlip").disabled=currentPayslipIndex===payslips.length-1;
}

function changePayslip(d){
  currentPayslipIndex+=d;
  if(currentPayslipIndex<0)currentPayslipIndex=0;
  if(currentPayslipIndex>payslips.length-1)currentPayslipIndex=payslips.length-1;
  updatePayslip();
  detectCurrentWeek();
  renderDates();
}

/* ================= WEEK ================= */

function detectCurrentWeek(){
  const today=new Date();
  const diff=Math.floor((today-cycleStartDate)/86400000);
  currentWeek=Math.floor(diff/7)+1;
  if(currentWeek<1)currentWeek=1;
  if(currentWeek>4)currentWeek=4;
}

function changeWeek(d){
  currentWeek+=d;
  if(currentWeek<1)currentWeek=1;
  if(currentWeek>4)currentWeek=4;
  renderDates();
}

function setView(v){
  currentView=v;
  if(v==="week")detectCurrentWeek();
  renderDates();
}

/* ================= TODAY BUTTON ================= */

function goToToday(){
  const today = new Date();

  // Find correct payslip
  for(let i=0;i<payslips.length;i++){
    let start=new Date(payslips[i]);
    let end=new Date(start);
    end.setDate(end.getDate()+27);
    if(today>=start && today<=end){
      currentPayslipIndex=i;
      break;
    }
  }

  updatePayslip();

  const diff=Math.floor((today-cycleStartDate)/86400000);
  currentWeek=Math.floor(diff/7)+1;
  if(currentWeek<1)currentWeek=1;
  if(currentWeek>4)currentWeek=4;

  if(currentView==="week"){
    renderDates();
  } else {
    // Month view
    renderDates();
    setTimeout(()=>{
      const row=document.querySelector(`[data-date="${today.toISOString().split("T")[0]}"]`);
      if(row) row.scrollIntoView({behavior:"smooth",block:"center"});
    },50);
  }
}


/* ================= STORAGE ================= */

function getKey(){
  return `tc_${currentUser}_${cycleStartDate.toISOString().split("T")[0]}`;
}

function autoSave(){
  let stored=JSON.parse(localStorage.getItem(getKey()))||{data:{},rate:null};
  stored.rate=document.getElementById("payRate").value;
  document.querySelectorAll("#rows tr").forEach(r=>{
    const date=r.dataset.date;
    stored.data[date]={
      in:r.querySelector(".in").value,
      out:r.querySelector(".out").value,
      br:r.querySelector(".br").value
    };
  });
  localStorage.setItem(getKey(),JSON.stringify(stored));
}

function loadData(){
  let stored=JSON.parse(localStorage.getItem(getKey()));
  if(!stored)return;
  if(stored.rate)document.getElementById("payRate").value=stored.rate;
  document.querySelectorAll("#rows tr").forEach(r=>{
    const date=r.dataset.date;
    if(stored.data[date]){
      r.querySelector(".in").value=stored.data[date].in||"";
      r.querySelector(".out").value=stored.data[date].out||"";
      r.querySelector(".br").value=stored.data[date].br||0;
    }
  });
}

/* ================= RENDER ================= */

function renderDates(){
  const tbody=document.getElementById("rows");
  tbody.innerHTML="";
  let days=currentView==="month"?28:7;
  let offset=currentView==="month"?0:(currentWeek-1)*7;

  for(let i=0;i<days;i++){
    let d=new Date(cycleStartDate);
    d.setDate(d.getDate()+offset+i);
    let row=document.createElement("tr");
    row.dataset.date=d.toISOString().split("T")[0];

    if(d.toDateString()===new Date().toDateString())
      row.classList.add("today-row");

    row.innerHTML=`
      <td>${d.toLocaleDateString("en-GB")}</td>
      <td><input type="time" class="in" onchange="autoSave();calculate();"></td>
      <td><input type="time" class="out" onchange="autoSave();calculate();"></td>
      <td><input type="number" step="0.01" class="br" value="0" onchange="autoSave();calculate();"></td>
      <td class="total">0.00</td>`;
    tbody.appendChild(row);
  }

  document.getElementById("weekControls").style.display=
  currentView==="month"?"none":"flex";

  document.getElementById("weekLabel").innerText=`Week ${currentWeek}`;

  loadData();
  calculate();
}

function calculate(){
  let total=0;
  document.querySelectorAll("#rows tr").forEach(r=>{
    const i=r.querySelector(".in").value;
    const o=r.querySelector(".out").value;
    const b=parseFloat(r.querySelector(".br").value)||0;
    if(i&&o){
      let diff=(new Date(`1970-01-01T${o}`)-new Date(`1970-01-01T${i}`))/3600000;
      if(diff<0)diff+=24;
      diff-=b;
      if(diff<0)diff=0;
      r.querySelector(".total").innerText=diff.toFixed(2);
      total+=diff;
    }else{
      r.querySelector(".total").innerText="0.00";
    }
  });
  document.getElementById("weekTotal").innerText=total.toFixed(2);
  document.getElementById("totalMoney").innerText=
  (total*parseFloat(document.getElementById("payRate").value)).toFixed(2);
}

/* ================= INIT ================= */

loadUserList();
updatePayslip();
detectCurrentWeek();
renderDates();

</script>
</body>
</html>
